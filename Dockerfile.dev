# Dockerfile.dev - Environnement de développement pour TCF Canada Backend
# Simule exactement l'environnement localhost pour Edge TTS et autres services

FROM python:3.11-slim-bullseye

# Métadonnées
LABEL maintainer="support@reussir-tcfcanada.com"
LABEL description="Backend TCF Canada - Environnement de développement avec simulation localhost"
LABEL version="1.0"

# Variables d'environnement pour Python et Flask
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    FLASK_ENV=development \
    FLASK_DEBUG=1 \
    PORT=5001 \
    PYTHONIOENCODING=utf-8 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Installation des dépendances système nécessaires
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    make \
    libmariadb-dev \
    libmariadb-dev-compat \
    pkg-config \
    default-libmysqlclient-dev \
    curl \
    wget \
    git \
    ca-certificates \
    openssl \
    libssl-dev \
    && update-ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Créer le répertoire de travail
WORKDIR /app

# Copier les fichiers de dépendances en premier (meilleure mise en cache)
COPY requirements.txt .

# Installer les dépendances Python
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt

# Copier tous les fichiers de l'application
COPY . .

# Créer les répertoires nécessaires
RUN mkdir -p /app/audio_responses \
    /app/instance \
    /app/tmp \
    /app/data \
    /app/migrations/versions

# Permissions pour les répertoires de données
RUN chmod -R 755 /app/audio_responses \
    /app/instance \
    /app/tmp \
    /app/data

# Copier le fichier .env.dev comme fichier .env par défaut
RUN if [ -f .env.dev ]; then cp .env.dev .env; fi

# Exposer le port de l'application
EXPOSE 5001

# Healthcheck pour vérifier que l'application est disponible
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:5001/docs || exit 1

# Script d'initialisation et démarrage
CMD ["python", "app.py"]